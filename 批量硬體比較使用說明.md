# 批量硬體 Probit 類比退火法比較實驗使用說明

## 概述

這個批次腳本 (`batch_hardware_comparison.py`) 用於自動化執行大量的硬體 Probit 類比退火法比較實驗。

## 功能特點

1. **自動化測試**：對 G1~G81 的所有 GSET 圖檔進行測試
2. **多種參數組合**：同時測試 4 種不同的 trial 和 timestep 組合
3. **結果分類存儲**：自動將結果按照參數組合分別存到不同資料夾
4. **進度追蹤**：即時顯示執行進度和統計資訊

## 測試參數組合

腳本會自動測試以下 4 種參數組合：

| 組合 | Trial | Timestep | 輸出資料夾 |
|------|-------|----------|-----------|
| 1 | 100 | 1,000 | `trial100_steps1000/` |
| 2 | 100 | 10,000 | `trial100_steps10000/` |
| 3 | 1,000 | 100 | `trial1000_steps100/` |
| 4 | 1,000 | 10,000 | `trial1000_steps10000/` |

## 輸出結構

```
hardware_comparison_results/
├── trial100_steps1000/
│   ├── comparison_G1_sync_trial100_steps1000_20251113_120000.csv
│   ├── histogram_G1_sync_trial100_20251113_120000.png
│   ├── energy_evolution_G1_sync_steps1000_20251113_120000.png
│   ├── detailed_results_G1_sync_trial100_20251113_120000.xlsx
│   ├── ... (G2~G81 的結果)
│   └── ...
├── trial100_steps10000/
│   └── ... (所有圖的結果)
├── trial1000_steps100/
│   └── ... (所有圖的結果)
└── trial1000_steps10000/
    └── ... (所有圖的結果)
```

## 使用方法

### 基本用法

```bash
python batch_hardware_comparison.py --graph_dir ./graph --start_graph 1 --end_graph 81
```

### 常用選項

```bash
# 只測試部分圖檔（例如 G1~G10）
python batch_hardware_comparison.py --start_graph 1 --end_graph 10

# 使用不同的退火排程
python batch_hardware_comparison.py --schedule linear

# 使用非同步更新模式
python batch_hardware_comparison.py --probit_mode asynchronous

# 調整 RPA 更新比例（僅同步模式）
python batch_hardware_comparison.py --epsilon 0.2

# 調整退火參數
python batch_hardware_comparison.py --sigma_start 10.0 --sigma_end 0.001

# Dry run（只顯示要執行的命令，不實際執行）
python batch_hardware_comparison.py --dry_run
```

### 完整參數說明

| 參數 | 說明 | 預設值 |
|------|------|--------|
| `--graph_dir` | 圖檔所在目錄 | `./graph` |
| `--start_graph` | 起始圖檔編號 | `1` |
| `--end_graph` | 結束圖檔編號 | `81` |
| `--sigma_start` | Probit 起始 sigma | `5.0` |
| `--sigma_end` | Probit 結束 sigma | `0.01` |
| `--T_start` | Traditional SA 起始溫度 | `5.0` |
| `--T_end` | Traditional SA 結束溫度 | `0.01` |
| `--schedule` | 退火排程 (`exponential` 或 `linear`) | `exponential` |
| `--probit_mode` | Probit 更新模式 (`synchronous` 或 `asynchronous`) | `synchronous` |
| `--epsilon` | RPA 更新比例（僅同步模式） | `0.1` |
| `--dry_run` | 僅顯示命令，不實際執行 | `False` |

## 執行範例

### 範例 1：完整測試（G1~G81）

```bash
python batch_hardware_comparison.py
```

這會執行：
- 81 個圖檔 × 4 種參數組合 = 324 個實驗
- 估計時間：根據圖檔大小和硬體配置而定

### 範例 2：快速測試（G1~G5）

```bash
python batch_hardware_comparison.py --start_graph 1 --end_graph 5
```

這會執行：
- 5 個圖檔 × 4 種參數組合 = 20 個實驗
- 適合測試腳本是否正常運作

### 範例 3：使用 Dry Run 預覽

```bash
python batch_hardware_comparison.py --start_graph 1 --end_graph 3 --dry_run
```

這會顯示所有要執行的命令，但不實際執行，用於確認設定是否正確。

### 範例 4：自定義參數

```bash
python batch_hardware_comparison.py \
    --start_graph 1 \
    --end_graph 20 \
    --sigma_start 10.0 \
    --sigma_end 0.001 \
    --schedule linear \
    --epsilon 0.15
```

## 輸出檔案說明

每個實驗會產生以下檔案：

### 1. CSV 摘要檔案
- 檔名格式：`comparison_G{num}_sync_trial{trial}_steps{steps}_{timestamp}.csv`
- 內容：兩種演算法的統計比較（平均值、標準差、最小值、最大值等）

### 2. 能量分佈直方圖
- 檔名格式：`histogram_G{num}_sync_trial{trial}_{timestamp}.png`
- 內容：兩種演算法的能量和 Cut 值分佈直方圖

### 3. 能量演化曲線
- 檔名格式：`energy_evolution_G{num}_sync_steps{steps}_{timestamp}.png`
- 內容：最後一次試驗的能量演化曲線

### 4. Excel 詳細結果
- 檔名格式：`detailed_results_G{num}_sync_trial{trial}_{timestamp}.xlsx`
- 內容：
  - Sheet 1 (Summary)：統計摘要
  - Sheet 2 (Detailed_Results)：每次試驗的詳細結果
  - Sheet 3 (Energy_Evolution)：能量演化數據

## 執行時間估算

執行時間取決於：
- 圖檔大小（節點數和邊數）
- Trial 次數
- Timestep 數量
- 硬體效能

粗略估算（假設平均每個實驗 1 分鐘）：
- G1~G5（小圖）：約 20 分鐘（20 個實驗）
- G1~G20（中圖）：約 80 分鐘（80 個實驗）
- G1~G81（完整）：約 5.5 小時（324 個實驗）

## 注意事項

1. **磁碟空間**：確保有足夠的磁碟空間存儲結果（每個實驗約 1-5 MB）
2. **記憶體**：大型圖檔可能需要較多記憶體
3. **中斷恢復**：目前不支援中斷後繼續，建議先用小範圍測試
4. **平行執行**：目前是序列執行，未來可考慮平行化

## 結果分析

執行完成後，你可以：

1. **查看個別圖檔的結果**：進入對應的資料夾查看 PNG 和 Excel 檔案
2. **比較不同參數組合**：比較 4 個資料夾中同一圖檔的結果
3. **統計分析**：使用 Excel 或 Python 進一步分析 CSV 檔案

## 常見問題

### Q1: 找不到圖檔？
**A:** 確認圖檔目錄正確，圖檔命名格式為 `G{num}.txt`（如 `G1.txt`）

### Q2: 執行時間太長？
**A:** 
- 先用 `--start_graph 1 --end_graph 5` 測試小範圍
- 考慮減少 trial 或 timestep（需修改腳本中的 `configs` 列表）

### Q3: 某些實驗失敗？
**A:** 
- 檢查終端輸出的錯誤訊息
- 確認原始程式 `hardware_multiple_spin_probit_annealing.py` 可以單獨執行
- 查看失敗的實驗列表（腳本結束時會顯示）

### Q4: 如何修改測試參數組合？
**A:** 修改 `batch_hardware_comparison.py` 中的 `create_output_directories` 函數的 `configs` 列表

```python
configs = [
    ('trial100_steps1000', 100, 1000),
    ('trial100_steps10000', 100, 10000),
    ('trial1000_steps100', 1000, 100),
    ('trial1000_steps10000', 1000, 10000),
    # 可以新增更多組合，例如：
    # ('trial500_steps5000', 500, 5000),
]
```

## 技術細節

### 硬體模擬說明

腳本使用 `hardware_multiple_spin_probit_annealing.py` 進行硬體層級模擬：

1. **Crossbar 權重**：權重轉換為 {0, 0.5, 1}（模擬硬體限制）
2. **Spin 暫存器**：使用 binary spin {0, 1}
3. **MVM 修正電路**：數位電路還原理想的本地場
4. **RPA 策略**：使用 epsilon 參數控制更新比例

### 環境變數

腳本通過環境變數 `HARDWARE_OUTPUT_DIR` 告訴子程序輸出目錄，讓結果直接存到正確的資料夾。

## 版本歷史

- **v1.0** (2025-01-13)：初始版本
  - 支援 G1~G81 批量測試
  - 4 種參數組合自動化
  - 結果分類存儲

## 作者與授權

與 `hardware_multiple_spin_probit_annealing.py` 相同

